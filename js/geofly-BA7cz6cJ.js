var O=(n,e,t)=>new Promise((r,o)=>{var s=a=>{try{c(t.next(a))}catch(f){o(f)}},i=a=>{try{c(t.throw(a))}catch(f){o(f)}},c=a=>a.done?r(a.value):Promise.resolve(a.value).then(s,i);c((t=t.apply(n,e)).next())});import{bh as z,w as F,az as G,k as W,b5 as Q,c as A}from"./bootstrap-CL17rep8.js";import{_ as q}from"./page.vue_vue_type_script_setup_true_lang-Bmglc92S.js";import{a5 as B,R as m,a6 as Y,a7 as $,af as H,ak as V,ah as S,ab as x,w as Z,al as J}from"../jse/index-index-BG6jV3fR.js";import"./x-BMVsyMFc.js";function X(n){if(document.querySelector(`script[src="${n}"]`))return Promise.resolve();const t=document.createElement("script");return t.type="text/javascript",new Promise((r,o)=>{t.addEventListener("load",r),t.addEventListener("error",o),t.src=n,document.querySelectorAll("head")[0].append(t)})}function K(n){const e=n.map(t=>X(t));return Promise.all(e)}var L=function(n,e){return L=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])},L(n,e)};function N(n,e){L(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function ee(n){var e=typeof Symbol=="function"&&n[Symbol.iterator],t=0;return e?e.call(n):{next:function(){return n&&t>=n.length&&(n=void 0),{value:n&&n[t++],done:!n}}}}function te(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var r=t.call(n),o,s=[],i;try{for(;(e===void 0||e-- >0)&&!(o=r.next()).done;)s.push(o.value)}catch(c){i={error:c}}finally{try{o&&!o.done&&(t=r.return)&&t.call(r)}finally{if(i)throw i.error}}return s}function ne(){for(var n=[],e=0;e<arguments.length;e++)n=n.concat(te(arguments[e]));return n}var D=function(){function n(e,t){this.target=t,this.type=e}return n}(),oe=function(n){N(e,n);function e(t,r){var o=n.call(this,"error",r)||this;return o.message=t.message,o.error=t,o}return e}(D),re=function(n){N(e,n);function e(t,r,o){t===void 0&&(t=1e3),r===void 0&&(r="");var s=n.call(this,"close",o)||this;return s.wasClean=!0,s.code=t,s.reason=r,s}return e}(D);var se=function(){if(typeof WebSocket!="undefined")return WebSocket},ie=function(n){return typeof n!="undefined"&&!!n&&n.CLOSING===2},y={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+Math.random()*4e3,minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},ae=function(){function n(e,t,r){var o=this;r===void 0&&(r={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(s){o._debug("open event");var i=o._options.minUptime,c=i===void 0?y.minUptime:i;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},c),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(a){return o._ws.send(a)}),o._messageQueue=[],o.onopen&&o.onopen(s),o._listeners.open.forEach(function(a){return o._callEventListener(s,a)})},this._handleMessage=function(s){o._debug("message event"),o.onmessage&&o.onmessage(s),o._listeners.message.forEach(function(i){return o._callEventListener(s,i)})},this._handleError=function(s){o._debug("error event",s.message),o._disconnect(void 0,s.message==="TIMEOUT"?"timeout":void 0),o.onerror&&o.onerror(s),o._debug("exec error listeners"),o._listeners.error.forEach(function(i){return o._callEventListener(s,i)}),o._connect()},this._handleClose=function(s){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(s),o._listeners.close.forEach(function(i){return o._callEventListener(s,i)})},this._url=e,this._protocols=t,this._options=r,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(n,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(n,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(n,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(n,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"CONNECTING",{get:function(){return n.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"OPEN",{get:function(){return n.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"CLOSING",{get:function(){return n.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"CLOSED",{get:function(){return n.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bufferedAmount",{get:function(){var e=this._messageQueue.reduce(function(t,r){return typeof r=="string"?t+=r.length:r instanceof Blob?t+=r.size:t+=r.byteLength,t},0);return e+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?n.CLOSED:n.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),n.prototype.close=function(e,t){if(e===void 0&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),!this._ws){this._debug("close enqueued: no ws instance");return}if(this._ws.readyState===this.CLOSED){this._debug("close: already closed");return}this._ws.close(e,t)},n.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,!this._ws||this._ws.readyState===this.CLOSED?this._connect():(this._disconnect(e,t),this._connect())},n.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,r=t===void 0?y.maxEnqueuedMessages:t;this._messageQueue.length<r&&(this._debug("enqueue",e),this._messageQueue.push(e))}},n.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},n.prototype.dispatchEvent=function(e){var t,r,o=this._listeners[e.type];if(o)try{for(var s=ee(o),i=s.next();!i.done;i=s.next()){var c=i.value;this._callEventListener(e,c)}}catch(a){t={error:a}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return!0},n.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(r){return r!==t}))},n.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,ne(["RWS>"],e))},n.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,r=t===void 0?y.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,s=o===void 0?y.minReconnectionDelay:o,i=e.maxReconnectionDelay,c=i===void 0?y.maxReconnectionDelay:i,a=0;return this._retryCount>0&&(a=s*Math.pow(r,this._retryCount-1),a>c&&(a=c)),this._debug("next delay",a),a},n.prototype._wait=function(){var e=this;return new Promise(function(t){setTimeout(t,e._getNextDelay())})},n.prototype._getNextUrl=function(e){if(typeof e=="string")return Promise.resolve(e);if(typeof e=="function"){var t=e();if(typeof t=="string")return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},n.prototype._connect=function(){var e=this;if(!(this._connectLock||!this._shouldReconnect)){this._connectLock=!0;var t=this._options,r=t.maxRetries,o=r===void 0?y.maxRetries:r,s=t.connectionTimeout,i=s===void 0?y.connectionTimeout:s,c=t.WebSocket,a=c===void 0?se():c;if(this._retryCount>=o){this._debug("max retries reached",this._retryCount,">=",o);return}if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!ie(a))throw Error("No valid WebSocket class provided");this._wait().then(function(){return e._getNextUrl(e._url)}).then(function(f){e._closeCalled||(e._debug("connect",{url:f,protocols:e._protocols}),e._ws=e._protocols?new a(f,e._protocols):new a(f),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout(function(){return e._handleTimeout()},i))})}},n.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new oe(Error("TIMEOUT"),this))},n.prototype._disconnect=function(e,t){if(e===void 0&&(e=1e3),this._clearTimeouts(),!!this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new re(e,t,this))}catch(r){}}},n.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},n.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},n.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},n.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},n.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},n}();const R=7e3,pe=B({__name:"geofly",setup(n){const e={d1:"ws://localhost",t1:"ws://43.157.29.131:6066",p0:"wss://gz.cdnbye.com",p1:"wss://eu.cdnbye.com",p3:"wss://hk.swarmcloud.net",p2:"wss://us.hdtvcloud.com"},t={0:"#B22222",1:"#33ff33",2:"#33ff33",3:"#1C86EE",4:"#FFD700",5:"#FF7F00",6:"#B22222",7:"#A020F0",8:"#ffffff"},{locale:r}=z(),o=m({}),s=m({}),i=m(null),c=m(null),a=m(!1),f=m(!1),C=m(!0),j=F(),P=G();function k(l){const u=window.L7,p=new u.Scene({id:"map",logoVisible:!1,map:new u.Mapbox({pitch:0,center:[16,25],style:"dark",zoom:1.5,token:"pk.eyJ1IjoiY2RuYnllIiwiYSI6ImNsMHE3ZmRxNDI3ZXczbHFrYm82Z2MyODEifQ.RTPyCND8dTNtHudmaQolwQ"})});o.value=p;const _=new window.MapboxLanguage({defaultLanguage:r.value==="en-US"?"en":"zh-Hant"});p.map.addControl(_);const h=[],g=new u.LineLayer({blend:"normal"}).size(.8).shape("greatcircle").color("color").animate({enable:!0,interval:.3,trailLength:.2,duration:3.5}).style({opacity:.6}),w=()=>{a.value&&!f.value&&(g.setData(h,{parser:{type:"json",x:"lon1",y:"lat1",x1:"lon2",y1:"lat2"}}),a.value=!1)},d=E=>{i.value=setTimeout(()=>{w();const v=h.length;v<100?d(200):v<500?d(1e3):v<1e3?d(3e3):d(1e4)},E)};d(200),p.on("loaded",()=>{var T;p.addLayer(g),C.value=!1;const E=j.accessUserId,v=`${e[l]}/flyline?uid=${E}&token=${(T=P.userInfo)==null?void 0:T.token}`;I(v,h)}),M()}function I(l,u){const p={maxRetries:5,minReconnectionDelay:5e3,maxReconnectionDelay:6e4},_=new ae(l,void 0,p);s.value=_,_.addEventListener("open",()=>{}),_.addEventListener("message",h=>{const g=h.data;let w;try{w=JSON.parse(g)}catch(E){A.error(g);return}const d=U(w);u.push(...d),u.length>R&&(u=u.slice(-R)),a.value=!0})}function M(){const l=o.value;l.on("movestart",()=>{b()}),l.on("zoomchange",()=>{b()}),l.on("zoomstart",()=>{b()}),l.on("dragging",()=>{b()})}function b(){c.value||(f.value=!0,c.value=setTimeout(()=>{f.value=!1,c.value=null},2e3))}function U(l){const u=[],{from:p,to:_}=l;return!p||!_||_.length===0||_.forEach(h=>{h.typ||(h.typ=0),u.push({lat1:p.lat,lon1:p.lon,lat2:h.lat,lon2:h.lon,color:t[h.typ]||"#B22222"})}),u}return Y(()=>O(this,null,function*(){const l=W();yield K(["https://api.tiles.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.js","https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js","https://cdn.jsdelivr.net/npm/@antv/l7@2.19.10/dist/l7.js"]),k(l)})),$(()=>{clearTimeout(i.value),clearTimeout(c.value),o.value&&o.value.destroy(),s.value&&s.value.close(1e3,"normal close")}),(l,u)=>(H(),V(x(Q),{spinning:C.value,size:"large"},{default:S(()=>[Z(x(q),{"auto-content-height":"","content-class":"!p-0"},{default:S(()=>u[0]||(u[0]=[J("div",{id:"map"},null,-1)])),_:1})]),_:1},8,["spinning"]))}});export{pe as default};
