var S=(n,e,t)=>new Promise((r,o)=>{var s=a=>{try{c(t.next(a))}catch(h){o(h)}},i=a=>{try{c(t.throw(a))}catch(h){o(h)}},c=a=>a.done?r(a.value):Promise.resolve(a.value).then(s,i);c((t=t.apply(n,e)).next())});import{bh as G,w as W,az as Q,k as q,b5 as A,o as B,c as Y}from"./bootstrap-Dm2SQx9s.js";import{_ as $}from"./page.vue_vue_type_script_setup_true_lang-BESDktLb.js";import{a5 as H,R as d,a6 as V,a7 as Z,af as J,ak as X,ah as x,ab as R,w as K,al as ee}from"../jse/index-index-CnArI7MG.js";import"./x-DWIRDBn_.js";function te(n){if(document.querySelector(`script[src="${n}"]`))return Promise.resolve();const t=document.createElement("script");return t.type="text/javascript",new Promise((r,o)=>{t.addEventListener("load",r),t.addEventListener("error",o),t.src=n,document.querySelectorAll("head")[0].append(t)})}function ne(n){const e=n.map(t=>te(t));return Promise.all(e)}var C=function(n,e){return C=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])},C(n,e)};function D(n,e){C(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function oe(n){var e=typeof Symbol=="function"&&n[Symbol.iterator],t=0;return e?e.call(n):{next:function(){return n&&t>=n.length&&(n=void 0),{value:n&&n[t++],done:!n}}}}function re(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var r=t.call(n),o,s=[],i;try{for(;(e===void 0||e-- >0)&&!(o=r.next()).done;)s.push(o.value)}catch(c){i={error:c}}finally{try{o&&!o.done&&(t=r.return)&&t.call(r)}finally{if(i)throw i.error}}return s}function se(){for(var n=[],e=0;e<arguments.length;e++)n=n.concat(re(arguments[e]));return n}var j=function(){function n(e,t){this.target=t,this.type=e}return n}(),ie=function(n){D(e,n);function e(t,r){var o=n.call(this,"error",r)||this;return o.message=t.message,o.error=t,o}return e}(j),ae=function(n){D(e,n);function e(t,r,o){t===void 0&&(t=1e3),r===void 0&&(r="");var s=n.call(this,"close",o)||this;return s.wasClean=!0,s.code=t,s.reason=r,s}return e}(j);var ce=function(){if(typeof WebSocket!="undefined")return WebSocket},ue=function(n){return typeof n!="undefined"&&!!n&&n.CLOSING===2},m={maxReconnectionDelay:1e4,minReconnectionDelay:1e3+Math.random()*4e3,minUptime:5e3,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,maxEnqueuedMessages:1/0,startClosed:!1,debug:!1},le=function(){function n(e,t,r){var o=this;r===void 0&&(r={}),this._listeners={error:[],message:[],open:[],close:[]},this._retryCount=-1,this._shouldReconnect=!0,this._connectLock=!1,this._binaryType="blob",this._closeCalled=!1,this._messageQueue=[],this.onclose=null,this.onerror=null,this.onmessage=null,this.onopen=null,this._handleOpen=function(s){o._debug("open event");var i=o._options.minUptime,c=i===void 0?m.minUptime:i;clearTimeout(o._connectTimeout),o._uptimeTimeout=setTimeout(function(){return o._acceptOpen()},c),o._ws.binaryType=o._binaryType,o._messageQueue.forEach(function(a){return o._ws.send(a)}),o._messageQueue=[],o.onopen&&o.onopen(s),o._listeners.open.forEach(function(a){return o._callEventListener(s,a)})},this._handleMessage=function(s){o._debug("message event"),o.onmessage&&o.onmessage(s),o._listeners.message.forEach(function(i){return o._callEventListener(s,i)})},this._handleError=function(s){o._debug("error event",s.message),o._disconnect(void 0,s.message==="TIMEOUT"?"timeout":void 0),o.onerror&&o.onerror(s),o._debug("exec error listeners"),o._listeners.error.forEach(function(i){return o._callEventListener(s,i)}),o._connect()},this._handleClose=function(s){o._debug("close event"),o._clearTimeouts(),o._shouldReconnect&&o._connect(),o.onclose&&o.onclose(s),o._listeners.close.forEach(function(i){return o._callEventListener(s,i)})},this._url=e,this._protocols=t,this._options=r,this._options.startClosed&&(this._shouldReconnect=!1),this._connect()}return Object.defineProperty(n,"CONNECTING",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(n,"OPEN",{get:function(){return 1},enumerable:!0,configurable:!0}),Object.defineProperty(n,"CLOSING",{get:function(){return 2},enumerable:!0,configurable:!0}),Object.defineProperty(n,"CLOSED",{get:function(){return 3},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"CONNECTING",{get:function(){return n.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"OPEN",{get:function(){return n.OPEN},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"CLOSING",{get:function(){return n.CLOSING},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"CLOSED",{get:function(){return n.CLOSED},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"binaryType",{get:function(){return this._ws?this._ws.binaryType:this._binaryType},set:function(e){this._binaryType=e,this._ws&&(this._ws.binaryType=e)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"retryCount",{get:function(){return Math.max(this._retryCount,0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"bufferedAmount",{get:function(){var e=this._messageQueue.reduce(function(t,r){return typeof r=="string"?t+=r.length:r instanceof Blob?t+=r.size:t+=r.byteLength,t},0);return e+(this._ws?this._ws.bufferedAmount:0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"extensions",{get:function(){return this._ws?this._ws.extensions:""},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"protocol",{get:function(){return this._ws?this._ws.protocol:""},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"readyState",{get:function(){return this._ws?this._ws.readyState:this._options.startClosed?n.CLOSED:n.CONNECTING},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"url",{get:function(){return this._ws?this._ws.url:""},enumerable:!0,configurable:!0}),n.prototype.close=function(e,t){if(e===void 0&&(e=1e3),this._closeCalled=!0,this._shouldReconnect=!1,this._clearTimeouts(),!this._ws){this._debug("close enqueued: no ws instance");return}if(this._ws.readyState===this.CLOSED){this._debug("close: already closed");return}this._ws.close(e,t)},n.prototype.reconnect=function(e,t){this._shouldReconnect=!0,this._closeCalled=!1,this._retryCount=-1,!this._ws||this._ws.readyState===this.CLOSED?this._connect():(this._disconnect(e,t),this._connect())},n.prototype.send=function(e){if(this._ws&&this._ws.readyState===this.OPEN)this._debug("send",e),this._ws.send(e);else{var t=this._options.maxEnqueuedMessages,r=t===void 0?m.maxEnqueuedMessages:t;this._messageQueue.length<r&&(this._debug("enqueue",e),this._messageQueue.push(e))}},n.prototype.addEventListener=function(e,t){this._listeners[e]&&this._listeners[e].push(t)},n.prototype.dispatchEvent=function(e){var t,r,o=this._listeners[e.type];if(o)try{for(var s=oe(o),i=s.next();!i.done;i=s.next()){var c=i.value;this._callEventListener(e,c)}}catch(a){t={error:a}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return!0},n.prototype.removeEventListener=function(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(function(r){return r!==t}))},n.prototype._debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._options.debug&&console.log.apply(console,se(["RWS>"],e))},n.prototype._getNextDelay=function(){var e=this._options,t=e.reconnectionDelayGrowFactor,r=t===void 0?m.reconnectionDelayGrowFactor:t,o=e.minReconnectionDelay,s=o===void 0?m.minReconnectionDelay:o,i=e.maxReconnectionDelay,c=i===void 0?m.maxReconnectionDelay:i,a=0;return this._retryCount>0&&(a=s*Math.pow(r,this._retryCount-1),a>c&&(a=c)),this._debug("next delay",a),a},n.prototype._wait=function(){var e=this;return new Promise(function(t){setTimeout(t,e._getNextDelay())})},n.prototype._getNextUrl=function(e){if(typeof e=="string")return Promise.resolve(e);if(typeof e=="function"){var t=e();if(typeof t=="string")return Promise.resolve(t);if(t.then)return t}throw Error("Invalid URL")},n.prototype._connect=function(){var e=this;if(!(this._connectLock||!this._shouldReconnect)){this._connectLock=!0;var t=this._options,r=t.maxRetries,o=r===void 0?m.maxRetries:r,s=t.connectionTimeout,i=s===void 0?m.connectionTimeout:s,c=t.WebSocket,a=c===void 0?ce():c;if(this._retryCount>=o){this._debug("max retries reached",this._retryCount,">=",o);return}if(this._retryCount++,this._debug("connect",this._retryCount),this._removeListeners(),!ue(a))throw Error("No valid WebSocket class provided");this._wait().then(function(){return e._getNextUrl(e._url)}).then(function(h){e._closeCalled||(e._debug("connect",{url:h,protocols:e._protocols}),e._ws=e._protocols?new a(h,e._protocols):new a(h),e._ws.binaryType=e._binaryType,e._connectLock=!1,e._addListeners(),e._connectTimeout=setTimeout(function(){return e._handleTimeout()},i))})}},n.prototype._handleTimeout=function(){this._debug("timeout event"),this._handleError(new ie(Error("TIMEOUT"),this))},n.prototype._disconnect=function(e,t){if(e===void 0&&(e=1e3),this._clearTimeouts(),!!this._ws){this._removeListeners();try{this._ws.close(e,t),this._handleClose(new ae(e,t,this))}catch(r){}}},n.prototype._acceptOpen=function(){this._debug("accept open"),this._retryCount=0},n.prototype._callEventListener=function(e,t){"handleEvent"in t?t.handleEvent(e):t(e)},n.prototype._removeListeners=function(){this._ws&&(this._debug("removeListeners"),this._ws.removeEventListener("open",this._handleOpen),this._ws.removeEventListener("close",this._handleClose),this._ws.removeEventListener("message",this._handleMessage),this._ws.removeEventListener("error",this._handleError))},n.prototype._addListeners=function(){this._ws&&(this._debug("addListeners"),this._ws.addEventListener("open",this._handleOpen),this._ws.addEventListener("close",this._handleClose),this._ws.addEventListener("message",this._handleMessage),this._ws.addEventListener("error",this._handleError))},n.prototype._clearTimeouts=function(){clearTimeout(this._connectTimeout),clearTimeout(this._uptimeTimeout)},n}();const N=7e3,me=H({__name:"geofly",setup(n){const e={d1:"ws://localhost",t1:"ws://43.157.29.131:6066",p0:"wss://gz.cdnbye.com",p1:"wss://eu.cdnbye.com",p3:"wss://hk.swarmcloud.net",p2:"wss://us.hdtvcloud.com"},t={0:"#B22222",1:"#33ff33",2:"#33ff33",3:"#1C86EE",4:"#FFD700",5:"#FF7F00",6:"#B22222",7:"#A020F0",8:"#ffffff"},{locale:r}=G(),o=d({}),s=d({}),i=d(null),c=d(null),a=d(!1),h=d(!1),T=d(!0),P=W(),k=Q(),I=B();function M(l,u){const p=window.L7,f=new p.Scene({id:"map",logoVisible:!1,map:new p.Mapbox({pitch:0,center:[16,25],style:"dark",zoom:1.5,token:"pk.eyJ1IjoiY2RuYnllIiwiYSI6ImNsMHE3ZmRxNDI3ZXczbHFrYm82Z2MyODEifQ.RTPyCND8dTNtHudmaQolwQ"})});o.value=f;const _=new window.MapboxLanguage({defaultLanguage:r.value==="en-US"?"en":"zh-Hant"});f.map.addControl(_);const y=[],v=new p.LineLayer({blend:"normal"}).size(.8).shape("greatcircle").color("color").animate({enable:!0,interval:.3,trailLength:.2,duration:3.5}).style({opacity:.6}),E=()=>{a.value&&!h.value&&(v.setData(y,{parser:{type:"json",x:"lon1",y:"lat1",x1:"lon2",y1:"lat2"}}),a.value=!1)},g=L=>{i.value=setTimeout(()=>{E();const b=y.length;b<100?g(200):b<500?g(1e3):b<1e3?g(3e3):g(1e4)},L)};g(200),f.on("loaded",()=>{var O;f.addLayer(v),T.value=!1;const L=P.accessUserId,b=`${u||e[l]}/flyline?uid=${L}&token=${(O=k.userInfo)==null?void 0:O.token}`;U(b,y)}),z()}function U(l,u){const p={maxRetries:5,minReconnectionDelay:5e3,maxReconnectionDelay:6e4},f=new le(l,void 0,p);s.value=f,f.addEventListener("open",()=>{}),f.addEventListener("message",_=>{const y=_.data;let v;try{v=JSON.parse(y)}catch(g){Y.error(y);return}const E=F(v);u.push(...E),u.length>N&&(u=u.slice(-N)),a.value=!0})}function z(){const l=o.value;l.on("movestart",()=>{w()}),l.on("zoomchange",()=>{w()}),l.on("zoomstart",()=>{w()}),l.on("dragging",()=>{w()})}function w(){c.value||(h.value=!0,c.value=setTimeout(()=>{h.value=!1,c.value=null},2e3))}function F(l){const u=[],{from:p,to:f}=l;return!p||!f||f.length===0||f.forEach(_=>{_.typ||(_.typ=0),u.push({lat1:p.lat,lon1:p.lon,lat2:_.lat,lon2:_.lon,color:t[_.typ]||"#B22222"})}),u}return V(()=>S(this,null,function*(){const l=q();yield ne(["https://api.tiles.mapbox.com/mapbox-gl-js/v2.4.0/mapbox-gl.js","https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js","https://cdn.jsdelivr.net/npm/@antv/l7@2.19.10/dist/l7.js"]);const{server:u}=I.query;M(l,u)})),Z(()=>{clearTimeout(i.value),clearTimeout(c.value),o.value&&o.value.destroy(),s.value&&s.value.close(1e3,"normal close")}),(l,u)=>(J(),X(R(A),{spinning:T.value,size:"large"},{default:x(()=>[K(R($),{"auto-content-height":"","content-class":"!p-0"},{default:x(()=>u[0]||(u[0]=[ee("div",{id:"map"},null,-1)])),_:1})]),_:1},8,["spinning"]))}});export{me as default};
