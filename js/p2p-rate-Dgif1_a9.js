var A=(B,m,r)=>new Promise((l,c)=>{var _=e=>{try{a(r.next(e))}catch(i){c(i)}},x=e=>{try{a(r.throw(e))}catch(i){c(i)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(_,x);a((r=r.apply(B,m)).next())});import{s as L}from"./vue-json-excel.esm-Cj2DiqS1.js";import{B as O,$ as U}from"./bootstrap-PGBUDbCq.js";import{a5 as j,R as D,aW as k,Y as F,J as G,X as I,ah as J,ai as w,ab as g,bw as W,ag as X,n as P,ap as Y,ar as q}from"../jse/index-index-BXx06mpc.js";import{a as z,b as K,D as Q}from"./history-data-DWSSh01O.js";import{_ as Z}from"./not-bind-tip.vue_vue_type_script_setup_true_lang-B46w7Z0a.js";import{u as tt}from"./app-o1KoIQWh.js";import{_ as at}from"./line-chart.vue_vue_type_script_setup_true_lang-CF6XgMcM.js";import{_ as et}from"./page.vue_vue_type_script_setup_true_lang-CXbajufZ.js";import{f as st,g as N}from"./format-B0PhllUt.js";import"./use-modal-CEA9RQg3.js";import"./x-Ba7vdtkv.js";import"./loading-btu9_ztw.js";import"./domain-CJPK5SCV.js";import"./use-echarts-CjCgNJfX.js";const ot={class:"md:pt-5"},_t=j({__name:"p2p-rate",setup(B){const m=tt(),r=D("week"),l=D([k().startOf("day").subtract(1,"week"),k().startOf("day")]),c=D(),_=D(),x=D(""),a=F({xData:[],unit:"%",yName:"Traffic"}),e=F({}),i=F({}),C=G(()=>r.value==="week"||r.value==="month");function b(){return A(this,arguments,function*(n=l.value[0],t=l.value[1]){var h;a.xData=[],e.P2P=[],e.HTTP=[],i.ratio=[];let u=5;C.value&&(u=1440);const f=(h=m.currentDomain)==null?void 0:h.id;if(!f)return;const d={start_ts:R(n),end_ts:R(t),gran:u},[y,E]=yield W(Promise.all([z(f,d),K(f,d)]));if(y)return;const[H,T]=E,s=H.list;c.value=s;const p=T.list;if(_.value=p,!s||!p)return;const v=[...s].sort((o,$)=>o.value-$.value);a.unit=st(v[v.length-1].value).unit,p.forEach(o=>{e.P2P.push(N(o.value,a.unit))}),s.forEach(o=>{a.xData.push(k(o.ts*1e3).format("MM-DD")),e.HTTP.push(N(o.value,a.unit))}),p.forEach((o,$)=>{const V=o.value>0&&s[$]?o.value/(o.value+s[$].value):0;i.ratio.push(Number((V*100).toFixed(1)))})})}function R(n){return n.unix()}function M(n,t){b(n,t)}I(()=>m.currentDomain,()=>{b()},{deep:!0});function S(){return A(this,null,function*(){var T;const n=[];_.value.forEach((s,p)=>{n.push({ts:s.ts,p2p:s.value,http:c==null?void 0:c.value[p].value})});const t=[];let u=0,f=0;const d=`P2P(${a.unit})`,y=`HTTP(${a.unit})`;n.forEach(s=>{const p=k(s.ts*1e3).format("MM-DD"),v=N(s.p2p,a.unit),h=N(s.http,a.unit);u+=Number.parseFloat(`${v}`),f+=Number.parseFloat(`${h}`),t.push({Date:p,[d]:v,[y]:h})});const E=(u/t.length).toFixed(2),H=(f/t.length).toFixed(2);return t.push({Date:"Avg",[d]:E,[y]:H}),x.value=`Traffic Statistics(${(T=m.currentDomain)==null?void 0:T.domain}).csv`,t})}return b(),(n,t)=>(X(),J(g(et),{description:g(U)("page.history.data.descGlobal")},{extra:w(()=>[P(g(O),{class:"mt-1",type:"primary"},{default:w(()=>[P(g(L),{fetch:S,name:x.value,type:"csv"},{default:w(()=>t[2]||(t[2]=[Y(" Export Excel ")])),_:1},8,["name"])]),_:1})]),default:w(()=>[P(Z),q("div",ot,[P(g(Q),{date:r.value,"onUpdate:date":t[0]||(t[0]=u=>r.value=u),range:l.value,"onUpdate:range":t[1]||(t[1]=u=>l.value=u),day:!1,hour:!1,"show-time":!1,onChange:M},null,8,["date","range"])]),P(at,{data:e,"option-data":a,"second-data":i,class:"mt-6","show-p2p":""},null,8,["data","option-data","second-data"])]),_:1},8,["description"]))}});export{_t as default};
